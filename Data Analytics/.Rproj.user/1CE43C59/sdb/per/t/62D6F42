{
    "collab_server" : "",
    "contents" : "library(data.table)\nlibrary(Hmisc)\nlibrary(dplyr)\nlibrary(VIM)\nlibrary(reshape2)\npath.wd <- getwd()\npath.input <- file.path(path.wd,\"Input\")\npath.output <- file.path(path.wd,\"Output\")\nar.rate <- fread(file.path(path.input,\"ar_rate_8_input.csv\"))\n\n#insight\ndescribe(ar.rate)\n\n#rate subset rate>0 \n##sum count avg count rate>=3.5\nar.rate.sub_rate <- subset(ar.rate,ar.rate$Rate>0,select = c(\"Date\",\"MID\",\"Rate\"))\ndescribe(ar.rate.sub_rate)\n##pivot\ntest <- ar.rate.sub_rate[ar.rate.sub_rate$MID%in%c(1,2),]\naggrfun_1 <- function(x) {\n  s = sum(x)\n  n = length(x)\n  c = length(subset(x,x>=3.5))\n  return(c(sum_rate = s,count_rate = n,count_35 = c))\n}\nattach(test)\ndetach(test)\nattach(ar.rate.sub_rate)\nar.aggr.rate.mix <- aggregate(Rate ~ MID+Date,FUN = aggrfun_1)\nar.aggr.rate <- data.frame(MID = ar.aggr.rate.mix$MID, Date = ar.aggr.rate.mix$Date, ar.aggr.rate.mix[[\"Rate\"]])\ndescribe(ar.aggr.rate)\n\n##math rate_avg\ndetach(ar.rate.sub_rate)\nattach(ar.aggr.rate)\nar.aggr.rate <- ar.aggr.rate[order(ar.aggr.rate$MID, ar.aggr.rate$Date),]\n\naggr.cumsum <- aggregate(sum_rate~MID, FUN = cumsum)\nar.aggr.rate <- cbind(ar.aggr.rate, sum_rate_cum = melt(aggr.cumsum$sum_rate)[,1])\naggr.countrate <-aggregate(count_rate~MID, FUN = cumsum)\nar.aggr.rate <- cbind(ar.aggr.rate, count_rate_cum = melt(aggr.countrate$count_rate)[,1])\nar.aggr.rate <- cbind(ar.aggr.rate, ar_avg = ar.aggr.rate$sum_rate_cum/ar.aggr.rate$count_rate_cum)\naggr.countrate35 <-aggregate(count_35~MID, FUN = cumsum)\nar.aggr.rate <- cbind(ar.aggr.rate, count_rate35_cum = melt(aggr.countrate35$count_35)[,1])\n\ndescribe(ar.aggr.rate)\nwrite.csv(ar.aggr.rate,file.path(path.output,\"ar_aggr_1_rate_cum.csv\"),row.names = F)\nrm(aggr.cumsum,aggr.countrate)\nrm(ar.aggr.rate.mix,ar.rate.sub_rate)\ndetach(ar.aggr.rate)\n#rate subset wts -1 ni -2\n##count -1$-2\nar.rate.sub_wn <- subset(ar.rate,ar.rate$Rate%in%c(-1,-2),select = c(\"Date\",\"MID\",\"Rate\"))\ndescribe(ar.rate.sub_wn)\ntest <- ar.rate.sub_wn[ar.rate.sub_wn$MID%in%c(1,2),]\nattach(test)\ndetach(test)\nattach(ar.rate.sub_wn)\n\naggrfun_2 <- function(x) {\n  c1 = length(subset(x,x==-1))\n  c2 = length(subset(x,x==-2))\n  return(c(count_wt = c1,count_ni = c2))\n}\nar.aggr.wn.mix <- aggregate(Rate ~ MID+Date,FUN = aggrfun_2)\nar.aggr.wn <- data.frame(MID = ar.aggr.wn.mix$MID, Date = ar.aggr.wn.mix$Date, ar.aggr.wn.mix[[\"Rate\"]])\n##math count_cum\ndetach(ar.rate.sub_wn)\nattach(ar.aggr.wn)\nar.aggr.wn <- ar.aggr.wn[order(ar.aggr.wn$MID, ar.aggr.wn$Date),]\n\naggr.cumsum_wt <- aggregate(count_wt~MID, FUN = cumsum)\nar.aggr.wn <- cbind(ar.aggr.wn, count_wt_cum = melt(aggr.cumsum_wt$count_wt)[,1])\naggr.cumsum_ni <- aggregate(count_ni~MID, FUN = cumsum)\nar.aggr.wn <- cbind(ar.aggr.wn, count_ni_cum = melt(aggr.cumsum_ni$count_ni)[,1])\ndescribe(ar.aggr.wn)\nwrite.csv(ar.aggr.wn,file.path(path.output,\"ar_aggr_2_wn_cum.csv\"),row.names = F)\nrm(aggr.cumsum_ni,aggr.cumsum_wt)\nrm(ar.aggr.wn.mix,ar.rate.sub_wn)\n\n\ndetach(ar.aggr.wn)\n#count rate+wtsni\n##subset rate>-3\n##aggregate length(rate)\nar.rate.sub_null <- subset(ar.rate,ar.rate$Rate>-3,select = c(\"Date\",\"MID\",\"Rate\"))\ndescribe(ar.rate.sub_null)\nattach(ar.rate.sub_null)\nar.aggr.volume.mix <- aggregate(Rate ~ MID+Date,FUN = length)\nar.aggr.volume <- data.frame(MID = ar.aggr.volume.mix$MID, Date = ar.aggr.volume.mix$Date, volume_day = ar.aggr.volume.mix[[\"Rate\"]])\nfix(ar.aggr.volume)\nar.aggr.volume <- ar.aggr.volume[order(ar.aggr.volume$MID, ar.aggr.volume$Date),]\ndetach(ar.rate.sub_null)\nattach(ar.aggr.volume)\naggr.cumsum_vol <- aggregate(volume_day~MID, FUN = cumsum)\nar.aggr.volume <- cbind(ar.aggr.volume, volume_cum = melt(aggr.cumsum_vol$volume_day)[,1])\ndescribe(ar.aggr.volume)\nwrite.csv(ar.aggr.volume,file.path(path.output,\"ar_aggr_3_vol_cum.csv\"),row.names = F)\nrm(aggr.cumsum_vol,ar.aggr.volume.mix,ar.rate.sub_null)\ndetach(ar.aggr.volume)\n#combination\nar.aggr <- full_join(ar.aggr.volume,ar.aggr.rate,by=c(\"MID\",\"Date\"))\nar.aggr <- full_join(ar.aggr, ar.aggr.wn,by=c(\"MID\",\"Date\"))\ndescribe(ar.aggr)\nwrite.csv(ar.aggr,file.path(path.output,\"ar_aggr_4_combination.csv\"),row.names = F)\nstr(ar.aggr)\n\n# dealing missing value -> math cum after combination\nar.aggr.sub <- subset(ar.aggr,select = c(\"MID\",\"Date\",\"volume_day\",\"sum_rate\",\"count_rate\",\"count_35\",\"count_wt\",\"count_ni\"))\nar.aggr.sub <- ar.aggr.sub[order(ar.aggr.sub$MID,ar.aggr.sub$Date),]\ndescribe(ar.aggr.sub)\nar.aggr.sub_ad <- impute(ar.aggr.sub,0)\nwrite.csv(ar.aggr.sub_ad, file.path(path.output,\"ar_aggr_5_subimpute.csv\"),row.names = F)\ndescribe(ar.aggr.sub_ad)\n\n## remath cum\nclass(ar.aggr.sub_ad) <- \"data.frame\"\nar.aggr.sub_ad <- ar.aggr.sub_ad[order(ar.aggr.sub_ad$MID,ar.aggr.sub_ad$Date),]\nattach(ar.aggr.sub_ad)\naggr.cumsum <- aggregate(sum_rate~MID, FUN = cumsum)\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad, sum_rate_cum = melt(aggr.cumsum$sum_rate)[,1])\naggr.countrate <-aggregate(count_rate~MID, FUN = cumsum)\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad, count_rate_cum = melt(aggr.countrate$count_rate)[,1])\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad, ar_avg = ar.aggr.sub_ad$sum_rate_cum/ar.aggr.sub_ad$count_rate_cum)\naggr.countrate35 <-aggregate(count_35~MID, FUN = cumsum)\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad, count_rate35_cum = melt(aggr.countrate35$count_35)[,1])\n\naggr.cumsum_wt <- aggregate(count_wt~MID, FUN = cumsum)\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad, count_wt_cum = melt(aggr.cumsum_wt$count_wt)[,1])\naggr.cumsum_ni <- aggregate(count_ni~MID, FUN = cumsum)\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad, count_ni_cum = melt(aggr.cumsum_ni$count_ni)[,1])\n\naggr.cumsum_vol <- aggregate(volume_day~MID, FUN = cumsum)\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad, volume_cum = melt(aggr.cumsum_vol$volume_day)[,1])\n\n##math audience score\naudiencescore = data.frame(Ascore = (ar.aggr.sub_ad$count_rate35_cum+ar.aggr.sub_ad$count_wt_cum)/ar.aggr.sub_ad$volume_cum)\ndescribe(audiencescore)\naudiencescore = cbind(audiencescore, Alabel = ifelse(ar.aggr.sub_ad$count_rate_cum>0,ifelse(ar.aggr.sub_ad$count_rate35_cum/ar.aggr.sub_ad$count_rate_cum>=0.6,1,2),3))\naudiencescore = cbind(audiencescore, wtsodd = ar.aggr.sub_ad$count_wt_cum/(ar.aggr.sub_ad$count_wt_cum+ar.aggr.sub_ad$count_ni_cum))\n\nar.aggr.sub_ad <- cbind(ar.aggr.sub_ad,audiencescore)\n\nwrite.csv(ar.aggr.sub_ad,file.path(path.output,\"ar_aggr_7_mathscore.csv\"),row.names = F)\n\ndescribe(ar.aggr.sub_ad)\nstr(ar.aggr.sub_ad)\ndetach(ar.aggr.sub_ad)\n#sr rate subset rate>0\n\n#sr rate subwts",
    "created" : 1493623088732.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "910361571",
    "id" : "62D6F42",
    "lastKnownWriteTime" : 1493364521,
    "last_content_update" : 1493364521,
    "path" : "D:/MicFile/百度云同步盘/R_Workspace/GraduateProject/DataProcessing/ar_extraction.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}